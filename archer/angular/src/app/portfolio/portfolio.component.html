<ng-container *ngIf="userObs | async as user">
  <div class="portfolio_container" *ngIf="userAssetsObs | async as userAssets">
    <portfolio-zero-state *ngIf="userAssets.length === 0"></portfolio-zero-state>
    <div class="portfolio" *ngIf="userAssets.length > 0">
      <div class="container" *ngVar="getPortfolioChange(userAssets) as changePercent">
        <div class="global_portfolio_section">
          <div class="title">Global Portfolio</div>
          <div class="totals">
            <div class="portfolio_value"
                 [ngClass]="changePercent >= 0 ? 'gain' : 'lose'">
              {{getPortfolioValue(userAssets) | currency: 'USD'}}
            </div>
            <div class="change_since_yesterday"
                 [ngClass]="changePercent >= 0 ? 'gain_bg' : 'lose_bg'">
              <percent-change [value]="changePercent"></percent-change>
            </div>
            <!--<div class="updated_at">At close: March 10 04:00 PM EST</div>-->
          </div>
        </div>

        <div class="chart_and_controls_container" *ngIf="portfolioValueHistoryObs | async as portfolioValueHistory">
          <div class="chart_container">
            <chart [chart]="getPortfolioChart(portfolioValueHistory, changePercent >= 0)"></chart>
          </div>
          <div class="controls">
            <button class="control_button" mat-flat-button
                    *ngFor="let timeFrame of allTimeFrames"
                    (click)="selectedTimeFrame.next(timeFrame)"
                    [ngClass]="{selected: selectedTimeFrame.value === timeFrame, gain: changePercent >= 0, lose: changePercent < 0}">

              {{timeFrame | uppercase}}
            </button>
          </div>
        </div>

        <div class="health_and_diversity">
          <div class="title">Portfolio Health & Diversity</div>
          <div class="stats">
            <div class="stat">
              <div class="stat_name">Total gain</div>
              <div class="stat_value" [ngClass]="totalGainPercent >= 0 ? 'gain' : 'lose'"
                   *ngVar="getTotalGainPercent(userAssets) as totalGainPercent">
                <span class="total_gain">{{getTotalGain(userAssets) | currency: 'USD'}}</span>
                (
                <percent-change [value]="totalGainPercent"></percent-change>
                )
              </div>
            </div>
            <div class="stat">
              <div class="stat_name">Cash holding</div>
              <div class="stat_value gain">{{user.balance | currency: 'USD'}}</div>
            </div>
            <div class="stat">
              <div class="stat_name">Total shares</div>
              <div class="stat_value gain"> {{ getTotalStockQuantity(userAssets) }} / {{userAssets.length}} holdings
              </div>
            </div>
          </div>
          <ng-container *ngIf="getAllocationsPerIndustry(userAssets) as allocArray">
            <div class="progress_bar_container">
              <div class="single_progress_bar" [ngClass]="'color'+(index + 1)"
                   [title]="alloc.sicDescription | titlecase"
                   *ngFor="let alloc of allocArray; let index = index" [style.width]="alloc.percentage + '%'"></div>
            </div>
            <div class="progress_bar_tags">
              <div class="tag" *ngFor="let alloc of allocArray; let index = index">
                <div class="bullet" [ngClass]="'color'+(index + 1)"></div>
                <div class="tag_text"><span class="description">{{alloc.sicDescription | titlecase}}</span> <span
                  class="bold">{{alloc.percentage / 100 | percent: '1.2'}}</span></div>
              </div>
            </div>
          </ng-container>
        </div>

        <div class="assets_table">
          <stock-table [tableData]="{data: convertToTableData(userAssets), type: 'userAssets'}"></stock-table>
        </div>
      </div>
    </div>
  </div>
</ng-container>
